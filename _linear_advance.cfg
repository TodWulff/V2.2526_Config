#####################################################################
# 	Linear Advance Stuffs - Adds M900 Support
#	used by Slicer G-Code and/or Plugins
#####################################################################

[gcode_macro _linadv_vars]
description:  led effects module variables

variable_linadv_verb_error:		1		# set to 0 to mute error reporting (um, errors.  lol)
variable_linadv_verb_info:		0	   # set to 0 to mute info reporting (has data)
variable_linadv_verb_status:	0	   # set to 0 to mute status reporting (useful modes, update, etc.)
variable_linadv_verb_debug:		0	   # set to 0 to mute debugs stuffs I added (proc entry/exit)

#	SET_GCODE_VARIABLE MACRO=_linadv_vars VARIABLE=dynamic_pa_enable VALUE=1

variable_dynamic_pa_enable:		1

gcode:
	# there is none

#--------------------------------------------------------------------

[delayed_gcode _linadv_module]		 
#description: Sets module-specific state flags for conditional use elsewhere.
initial_duration: 0.5							# have this at 0.5s as init code in _startup_autoexec.cfg runs at 0.1s after start
gcode:

	{% if printer["gcode_macro _linadv_vars"].linadv_verb_status %}  M118 >>> _linadv_module_start Start <<< {% endif %}

	SAVE_VARIABLE VARIABLE=module_linadv_loaded VALUE=1					#flag via persistent variable that this module is loaded
	SAVE_VARIABLE VARIABLE=linadv_err_flag VALUE=0						#init error flag via persistent variable that this module is not in error

	{% if printer["gcode_macro _linadv_vars"].linadv_verb_status %}  M118 >>> _linadv_module_start End <<< {% endif %}

#--------------------------------------------------------------------

[gcode_macro M900]
description: Set Pressure Advance - Param K=K-Factor|float, other params are ignored

variable_verbose:					False	# Enable verbose output

gcode:
	{% if 'K' in params %}
		{% if printer["gcode_macro _linadv_vars"].linadv_verb_info %} 
			{ action_respond_info('PA:' + params.K|float|string + ' ST:' + printer.extruder.smooth_time|float|string ) }
		{% endif %}
		SET_PRESSURE_ADVANCE ADVANCE={params.K|float}	# SMOOTH_TIME=<pressure_advance_smooth_time>
	{% else %}
		{% if printer["gcode_macro _linadv_vars"].linadv_verb_error %} 
			M118 >>> M900: No PA K-factor passed... <<<
		{% endif %}
	{% endif %}

#--------------------------------------------------------------------

[gcode_macro _SetDynamicPA]
description: Used to set klipper's PA based on specific mesh types passed in gcode
# parameter to be passed is a case-insenitive spaces-inclusive string MESH="mesh name"
variable_mesh_name =	["Unknown",	"Perimeter",	"External perimeter",	"Overhang perimeter",	"Internal infill",	"Solid infill",	"Top solid infill",	"Ironing",	"Bridge infill",	"Gap fill",		"Skirt/Brim",	"Support material",	"Support material interface",	"Wipe tower",	"Custom",	"Mixed"		]
variable_mesh_kval =	[0.0,			0.035,			0.0,						0.0,					0.085,			0.085,			0.085,				0.0,		0.085,				0.085,			0.085,			0.085,				0.085,							0.0,			0.085,		0.035	]
variable_mesh_smtm =	[0.040,			0.040,			0.040,						0.040,					0.040,			0.040,			0.040,				0.040,		0.040,				0.040,			0.040,			0.040,				0.040,							0.040,			0.040,		0.040	]

gcode:

	{% if printer["gcode_macro _linadv_vars"].dynamic_pa_enable %}

	{% if printer["gcode_macro _linadv_vars"].linadv_verb_status %}  M118 >>> _SetDynamicPA Start <<< {% endif %}

		{% set sdpa = namespace(pa_unset=true) %}
		{% set spdb = namespace(matches=0) %}
		
		{% for mesh_idx in range(printer["gcode_macro _SetDynamicPA"].mesh_name|length) %}
			{% if params.MESH|string|lower == printer["gcode_macro _SetDynamicPA"].mesh_name[mesh_idx|int]|string|lower %}
				SET_PRESSURE_ADVANCE ADVANCE={printer["gcode_macro _SetDynamicPA"].mesh_kval[mesh_idx|int]|float} SMOOTH_TIME={printer["gcode_macro _SetDynamicPA"].mesh_smtm[mesh_idx|int]|float}
				{% set sdpa.pa_unset = false %}
				{% set sdpb.matches = sdpb.matches + 1 %}
			{% endif %}
		{% endfor %}

		{% if sdpa.pa_unset %}
			{% if printer["gcode_macro _linadv_vars"].linadv_verb_error %} 
				M118 >>> _SetDynamicPA|UNKNOWN MESH: {params.MESH|string|lower} <<< 
				M300 S200 P50	# emit shortest possible low-freq bloop, a low-irritation get-user-attention thing about no spda setting
			{% endif %}		
		{% endif %}
		
		# {% if sdpb.matches > 1 %}
			{% if printer["gcode_macro _linadv_vars"].linadv_verb_error %} 
				M118 >>> _SetDynamicPA|Multiple matches on MESH: {params.MESH|string|lower} - matched {sdpb.matches} times <<< 
				M300 S200 P50	# emit shortest possible low-freq bloop, a low-irritation get-user-attention thing about no spda setting
			{% endif %}		
		# {% endif %}
		
	{% if printer["gcode_macro _linadv_vars"].linadv_verb_status %}  M118 >>> _SetDynamicPA End <<< {% endif %}
		
	{% endif %}

#--------------------------------------------------------------------
